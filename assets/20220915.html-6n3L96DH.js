import{_ as s,c as a,b as p,o as t}from"./app-D0wlB8dq.js";const e={};function l(i,n){return t(),a("div",null,n[0]||(n[0]=[p(`<h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p>miniprogram-ci 是从微信开发者工具中抽离的关于小程序/小游戏项目代码的编译模块。</p><p>开发者可不打开小程序开发者工具，独立使用 miniprogram-ci 进行小程序代码的上传、预览等操作。</p><h2 id="获取小程序代码上传密钥和配置ip白名单" tabindex="-1"><a class="header-anchor" href="#获取小程序代码上传密钥和配置ip白名单"><span>获取小程序代码上传密钥和配置IP白名单</span></a></h2><ol><li>打开微信公众平台后台-&gt; 开发 -&gt; 开发管理 -&gt; 开发设置 -&gt; 小程序代码上传 -&gt; 小程序代码上传密钥(如果没有，点击重置并下载保存好)</li><li>打开微信公众平台后台-&gt; 开发 -&gt; 开发管理 -&gt; 开发设置 -&gt; 小程序代码上传 -&gt; IP白名单(填写用于打包编译上传小程序代码的服务器的IP地址)</li></ol><h2 id="编写上传小程序代码的脚本" tabindex="-1"><a class="header-anchor" href="#编写上传小程序代码的脚本"><span>编写上传小程序代码的脚本</span></a></h2><ol><li><p>新建ci文件夹并将各个环境的上传密钥保存到ci文件夹下面，ci/private-key/development.key, ci/private-key/test.key, ci/private-key/production.key,</p></li><li><p>初始化miniprogram-ci包</p></li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">npm</span> <span class="token function">install</span> miniprogram-ci --save-dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="3"><li>编写上传小程序代码的脚本 ci文件夹下面，新建文件setting.json</li></ol><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;v1.0.0&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;desc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;机器人上传 v1.0.0&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;setting&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;es6&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;es7&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;minify&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;minifyJS&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;minifyWXML&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;minifywXSS&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;autoPrefixWXSS&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;codeProtect&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ci文件夹下面，新建文件 upload.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> ci <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;miniprogram-ci&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token constant">ENV</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> appid <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">../src/project.config.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">ENV</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> version<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> setting <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./setting.json&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;appid: &#39;</span> <span class="token operator">+</span> appid<span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;version: &#39;</span> <span class="token operator">+</span> version<span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;desc: &#39;</span> <span class="token operator">+</span> desc<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> project <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ci<span class="token punctuation">.</span>Project</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  appid<span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;miniProgram&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">projectPath</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;../dist&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">privateKeyPath</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">./private-key/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">ENV</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.key</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">ignores</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;node modules/**/*&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 上传代码</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ci<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      project<span class="token punctuation">,</span></span>
<span class="line">      desc<span class="token punctuation">,</span></span>
<span class="line">      version<span class="token punctuation">,</span></span>
<span class="line">      setting<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">onProgressUpdate</span><span class="token operator">:</span> console<span class="token punctuation">.</span>log<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;上传成功&#39;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;上传失败：&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="修改package-json-增加下面命令" tabindex="-1"><a class="header-anchor" href="#修改package-json-增加下面命令"><span>修改package.json，增加下面命令</span></a></h2><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;upload:dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node ./ci/upload.js development&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;upload:uat&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node ./ci/upload.js test&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;upload:prod&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node ./ci/upload.js production&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="配置持续集成和ci脚本" tabindex="-1"><a class="header-anchor" href="#配置持续集成和ci脚本"><span>配置持续集成和CI脚本</span></a></h2><p>例如coding上的配置如下：</p><div class="language-groovy line-numbers-mode" data-highlighter="prismjs" data-ext="groovy" data-title="groovy"><pre><code><span class="line">  pipeline <span class="token punctuation">{</span></span>
<span class="line">    agent any</span>
<span class="line">    stages <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;检出&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        steps <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">&#39;GitSCM&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            branches<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token punctuation">:</span> GIT_BUILD_REF<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">&#39;CloneOption&#39;</span><span class="token punctuation">,</span> noTags<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> depth<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> shallow<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            userRemoteConfigs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span></span>
<span class="line">              url<span class="token punctuation">:</span> GIT_REPO_URL<span class="token punctuation">,</span></span>
<span class="line">              credentialsId<span class="token punctuation">:</span> CREDENTIALS_ID</span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;构建&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          steps <span class="token punctuation">{</span></span>
<span class="line">            echo <span class="token string">&#39;构建中...&#39;</span></span>
<span class="line">            script <span class="token punctuation">{</span></span>
<span class="line">              sh <span class="token string">&#39;node -v&#39;</span></span>
<span class="line">              sh <span class="token string">&#39;npm -v&#39;</span></span>
<span class="line">              sh <span class="token string">&#39;npm run cache dir&#39;</span></span>
<span class="line">              sh <span class="token string">&#39;yarn config set registry &quot;https://registry.npmmirror.com&quot;&#39;</span></span>
<span class="line">              sh <span class="token string">&#39;npm install&#39;</span></span>
<span class="line">              sh <span class="token string">&#39;npm run build:dev&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            echo <span class="token string">&#39;打包完成.&#39;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;上传&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          steps <span class="token punctuation">{</span></span>
<span class="line">            echo <span class="token string">&#39;上传中...&#39;</span></span>
<span class="line">            script <span class="token punctuation">{</span></span>
<span class="line">              sh <span class="token string">&#39;yarn upload:dev&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            echo <span class="token string">&#39;上传完成.&#39;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,17)]))}const c=s(e,[["render",l],["__file","20220915.html.vue"]]),u=JSON.parse('{"path":"/blogs/Frontend/20220915.html","title":"如何实现小程序代码自动上传","lang":"en-US","frontmatter":{"title":"如何实现小程序代码自动上传","date":"2022-09-15T00:00:00.000Z","tags":["CI","微信小程序"],"categories":["Frontend"]},"headers":[{"level":2,"title":"前言","slug":"前言","link":"#前言","children":[]},{"level":2,"title":"获取小程序代码上传密钥和配置IP白名单","slug":"获取小程序代码上传密钥和配置ip白名单","link":"#获取小程序代码上传密钥和配置ip白名单","children":[]},{"level":2,"title":"编写上传小程序代码的脚本","slug":"编写上传小程序代码的脚本","link":"#编写上传小程序代码的脚本","children":[]},{"level":2,"title":"修改package.json，增加下面命令","slug":"修改package-json-增加下面命令","link":"#修改package-json-增加下面命令","children":[]},{"level":2,"title":"配置持续集成和CI脚本","slug":"配置持续集成和ci脚本","link":"#配置持续集成和ci脚本","children":[]}],"git":{"createdTime":1734342184000,"updatedTime":1734342184000,"contributors":[{"name":"wanggang","email":"wanggang@shouyinongye.com","commits":1}]},"filePathRelative":"blogs/Frontend/20220915.md"}');export{c as comp,u as data};
